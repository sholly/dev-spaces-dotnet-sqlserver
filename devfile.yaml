schemaVersion: 2.2.2
metadata:
  name: dot-net-workspace
components:
  - name: tools
    # Note This Devfile only works on OCP 4.18+ with user namespace support enabled - https://github.com/cgruver/ocp-4-18-nested-container-tech-preview
    attributes:
      pod-overrides:
        metadata:
          annotations:
            # Ask for /dev/fuse and /dev/net/tun to be mapped into this Pod
            io.kubernetes.cri-o.Devices: "/dev/fuse,/dev/net/tun"
        spec:
          # Instruct the container runtime to create a new user namespace for the containers in this Pod.
          hostUsers: false
      container-overrides: 
        securityContext:
          # Ask for an unmasked /proc to be available to this container
          procMount: Unmasked
    container:
      image: quay.io/cgruver0/che/dot-net:ubi
      mountSources: true
      cpuRequest: 50m
      cpuLimit: 1000m
      memoryRequest: 1Gi
      memoryLimit: 4Gi
      env:
        - name: SHELL
          value: "/bin/zsh"
        - name: HOME
          value: "/projects/home"
        - name: VSCODE_DEFAULT_WORKSPACE
          value: "/projects/dev-spaces-dotnet/dev-spaces-dotnet.code-workspace"
        - name: ASPNETCORE_URLS
          value: "http://0.0.0.0:5000"
      endpoints:
        - exposure: public
          name: debug
          protocol: https
          targetPort: 5000
        - exposure: public
          name: 'api-endpoint'
          protocol: https
          targetPort: 5154
          path: '/api/challenge'
  - name: prep-workspace
    container:
      args:
        - '-c'
        - >-
          mkdir -p /projects/bin && cp /usr/bin/oc /projects/bin/oc && cp /usr/bin/kubectl /projects/bin/kubectl && if [[ -f ${HOME}/.kube/config ]]; then rm ${HOME}/.kube/config; fi
      command:
        - /bin/bash
      image: image-registry.openshift-image-registry.svc:5000/openshift/cli:latest
      mountSources: true
      sourceMapping: /projects
      memoryRequest: 128Mi
      memoryLimit: 256Mi
      cpuRequest: 10m
      cpuLimit: 200m
      env:
      - name: HOME
        value: "/projects/home"
events:
  preStart:
    - prep-workspace
commands:
  - id: prep-workspace
    apply:
      component: prep-workspace
      label: Pre Start Prep
  - id: 1-update-dependencies
    exec:
      label: 1.Update dependencies
      component: tools
      workingDir: /projects/dev-spaces-dotnet/src
      commandLine: "dotnet restore"
      group:
        kind: build
  - id: 2-build
    exec:
      label: 2.Build
      component: tools
      workingDir: /projects/dev-spaces-dotnet/src
      commandLine: "dotnet build"
      group:
        kind: build
  - id: 3-test
    exec:
      label: 3.Test
      component: tools
      workingDir: /projects/dev-spaces-dotnet/test
      commandLine: "dotnet test"
      group:
        kind: run
  - id: 4-run
    exec:
      label: 4.Run
      component: tools
      workingDir: /projects/dev-spaces-dotnet/src
      commandLine: "dotnet run"
      group:
        kind: run
  - id: 5-run-live-mode
    exec:
      label: 5.Run (Hot Reload)
      component: tools
      workingDir: /projects/dev-spaces-dotnet/src
      commandLine: "dotnet watch run"
      group:
        kind: run
